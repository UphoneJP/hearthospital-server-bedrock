<% layout("layouts/boilerplate") %>
<h4 class="text-center">
    病院指標
    <small class="text-secondary">独自まとめ</small>
</h4>

<%- include("hospitalDataPartial/modalOfFilter") %>
<%- include("hospitalDataPartial/dialog")%>

<div class="row flex-grow-1 h-100 position-relative">
    <%- include("hospitalDataPartial/mask")%>

    <div class="col-md-3 d-flex flex-column mb-3">
        <!-- ボタンとスマホ用 -->
        <%- include("hospitalDataPartial/DPCsummarySP")%>
        <%- include("hospitalDataPartial/KcodesummarySP")%>
        <%- include("hospitalDataPartial/dataForSP")%>
    </div>
    
    <!-- デスクトップ用 -->
    <div class="col-md-9 d-flex flex-column h-100 d-none d-md-block">
        <div class="h-100 rounded-5" id="startPage">
            <%- include("hospitalDataPartial/DPCsummaryPC") %>
            <%- include("hospitalDataPartial/KcodesummaryPC") %>
            <%- include("hospitalDataPartial/dataForPC") %>
        </div>
    </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

<script nonce="<%=nonce%>">
    const hospitals = <%- JSON.stringify(hospitals) %>;
    const DPCcodeName = <%- JSON.stringify(DPCcodeName) %>;
    const KcodeName = <%- JSON.stringify(KcodeName) %>;

    const sortSelectors = document.querySelectorAll(".sortSelector");
    const dataSheets = document.querySelectorAll(".dataSheet");
    const DPCSelectedYears = document.querySelectorAll(".DPCSelectedYear");
    const KcodeSelectedYears = document.querySelectorAll(".KcodeSelectedYear");
    const yearsData = ["R3", "R4", "R5", "R6"];
    const disease1 = ["x0010","x10100","x10101","x10110","x10111"]; // 大血管転位症手術等
    const disease2 = ["x0020","x0021","x1020"]; // ファロー四徴症手術等
    const disease3 = ["x1021","e14029xxx01x0xx"]; // 弁形成術等
    const disease4 = ["x0030","x1030","x1031"]; //  心室中隔欠損閉鎖術
    const disease5 = ["x0970","e50080xx0101xx","e50210xx97000x"]; // その他の手術
    const diseases = [disease1, disease2, disease3, disease4, disease5];

    function sortHospitalDPC(hospitals, codes, year) {
        let arrays = [];
        let name = `${year}DPCcode`;
        for(let hospital of hospitals){
            let sum = 0;
            for(let code of codes){
                if(hospital[name]&&hospital[name][code]){
                    sum += hospital[name][code][1];
                }
            }
            if(sum>0){arrays.push({hospital,sum})}
        }
        arrays = arrays.sort((a, b)=> b.sum - a.sum)
        return arrays;
    }
    function sortHospitalKcode(hospitals, codes, year) {
        let arrays = [];
        let name = `${year}Kcode`;
        for(let hospital of hospitals){
            let sum = 0;
            for(let code of Object.keys(codes)){
                if(hospital[name]&&hospital[name][code]){
                    sum += hospital[name][code][0];
                }
            }
            if(sum>0){arrays.push({hospital,sum})}
        }
        arrays = arrays.sort((a, b) => b.sum - a.sum);
        return arrays;
    }
    function calcPatientsDPC(hospital, codes, year) {
        let sum = 0;
        let name = `${year}DPCcode`;
        for (let code of codes) {
            if (hospital[name] && hospital[name][code]) {
                sum += hospital[name][code][1];
            }
        }
        return sum;
    }
    function coloringOrBold(hospital, disease, year){
      if(calcPatientsDPC(hospital, disease, year) >= 30){
        return "text-danger fw-bold"
      } else if (calcPatientsDPC(hospital, disease, year) >= 20) {
        return "text-danger"
      } else {
        return ""
      }
    }
    function check0orNot(hospital,disease){
        for(let year of yearsData){
            if(calcPatientsDPC(hospital,disease, year)!==0) return true
        }
        return false
    }
    function calcNumber(hospital,disease){
        const number = [];
        for(let year of yearsData){
            number.push(calcPatientsDPC(hospital,disease, year))
        }
        return number
    }

//病院情報を開いている場合にボタンをアクティブにする
    const btns = document.querySelectorAll(".btn");
    btns.forEach(btn => {
        // MutationObserver のコールバック関数
        const observer = new MutationObserver(mutations => {
            mutations.forEach(mutation => {
                if (mutation.attributeName === "aria-expanded") {
                    if (btn.getAttribute("aria-expanded") === "true") {
                        btn.classList.add("active");
                    } else {
                        btn.classList.remove("active"); 
                    }
                }
            });
        });
        observer.observe(btn, { attributes: true });
    });

// セレクターでDPCsummary表を操作する
    // 年度をセレクト
    DPCSelectedYears.forEach(selectedYear=>{
        selectedYear.addEventListener("change", ()=>{
            sortSelectors.forEach(sortSelector=>{
                sortSelector.value = "DPCcodeName"; // ソートをリセット
            })
            dataSheets.forEach(dataSheet=>{
                dataSheet.innerHTML = ""; // 既存のテーブル内容をクリア
                sortHospitalDPC(hospitals,DPCcodeName,selectedYear.value).forEach((hospital, index)=>{
                    const rowParts = [];
                    rowParts.push(`
                      <tr>
                        <th scope="col">${index + 1}</th>
                        <td scope="col">
                          <a href="/hospital/${hospital.hospital._id}">
                            ${hospital.hospital.hospitalname}
                          </a>
                        </td>
                        <td scope="col">
                          ${calcPatientsDPC(hospital.hospital, DPCcodeName, selectedYear.value)}
                        </td>
                    `);

                    for (let disease of diseases) {
                      rowParts.push(`
                        <td scope="col" class="${coloringOrBold(hospital.hospital, disease, selectedYear.value)}">
                          ${calcPatientsDPC(hospital.hospital, disease, selectedYear.value)}
                        </td>
                      `);
                    }

                    rowParts.push(`</tr>`);
                    const row = rowParts.join("");
                    dataSheet.insertAdjacentHTML("beforeend", row);
                });
            });
        })

        // sortをかけて順番入れ替え
        sortSelectors.forEach(sortSelector => {
            sortSelector.addEventListener("change", function(){
                const value = this.value;
                let codes;
                try{
                    codes = JSON.parse(value);
                } catch {
                    codes = DPCcodeName;
                }
                dataSheets.forEach(dataSheet=>{
                    dataSheet.innerHTML = ""; // 既存のテーブル内容をクリア
                    sortHospitalDPC(hospitals,codes,selectedYear.value).forEach((hospital, index)=>{
                        const rowParts = [];
                        rowParts.push(`
                          <tr>
                            <th scope="col">${index + 1}</th>
                            <td scope="col">
                              <a href="/hospital/${hospital.hospital._id}">
                                ${hospital.hospital.hospitalname}
                              </a>
                            </td>
                            <td scope="col">
                              ${calcPatientsDPC(hospital.hospital, DPCcodeName, selectedYear.value)}
                            </td>
                        `);

                        for (let disease of diseases) {
                          rowParts.push(`
                            <td scope="col" class="${coloringOrBold(hospital.hospital, disease, selectedYear.value)}">
                              ${calcPatientsDPC(hospital.hospital, disease, selectedYear.value)}
                            </td>
                          `);
                        }

                        rowParts.push(`</tr>`);
                        const row = rowParts.join("");
                        dataSheet.insertAdjacentHTML("beforeend", row);
                    });
                });
            });
        });
    })
    
// セレクターでKcodeSummaryグラフを操作する
    const ctxSP = document.querySelector("#KcodeSummarySP").getContext("2d");
    const ctxPC = document.querySelector("#KcodeSummaryPC").getContext("2d");
    let year = "R6";
    let labelName = sortHospitalKcode(hospitals, KcodeName, "R6").map(hospital=>hospital.hospital.hospitalname);
    let datas = [];
    for(let Kcode in KcodeName){
        const d = [];
        sortHospitalKcode(hospitals, KcodeName, "R6").forEach(hospital=>{
            if(
                hospital.hospital.R6Kcode&&
                hospital.hospital.R6Kcode[Kcode]
            ){
                d.push(hospital.hospital.R6Kcode[Kcode][0])
            } else {
                d.push(0)
            }
        });

        if(d.some(num => num !== 0)){
            const data = {
                label: KcodeName[Kcode],
                data: d,
            };
            datas.push(data)
        }
    }

    const options = {
        type: "bar",
        data: {
            labels: labelName,
            datasets: datas
        },
        options: {
            responsive: true,
            scales: {
                x: {
                    stacked: true,
                    ticks: {
                        autoSkip: false,
                        maxRotation: 90,
                        minRotation: 90
                    }
                },
                y: {
                    stacked: true,
                }
            },
            plugins: {
                legend: {
                    position: "top",
                    align: "start",
                    labels: {
                        boxWidth: 10,
                        textAlign: "left",
                    }
                }
            }
        }
    }
    let myChartSP = new Chart(ctxSP, options);  
    let myChartPC = new Chart(ctxPC, options);  

    // 年度の変更
    KcodeSelectedYears.forEach(KcodeSelectedYear=>{
        KcodeSelectedYear.addEventListener("change", ()=>{
            year =  KcodeSelectedYear.value;
            datas = [];
            const yearName = `${year}Kcode`;
            const sortedHospitals = sortHospitalKcode(hospitals, KcodeName, year);

            for(let Kcode in KcodeName){
                const d = [];
                sortedHospitals.forEach(hospital=>{
                    if(
                        hospital.hospital[yearName]&&
                        hospital.hospital[yearName][Kcode]
                    ){
                        d.push(hospital.hospital[yearName][Kcode][0])
                    } else {
                        d.push(0)
                    }
                });

                if(d.some(num => num !== 0)){
                    const data = {
                        label: KcodeName[Kcode],
                        data: d,
                    };
                    datas.push(data)
                }
            }
            labelName = sortedHospitals.map(hospital=>hospital.hospital.hospitalname);

            if (myChartSP) myChartSP.destroy();
            if (myChartPC) myChartPC.destroy();

            const options = {
                type: "bar",
                data: {
                    labels: labelName,
                    datasets: datas
                },
                options: {
                    responsive: true,
                    scales: {
                        x: {
                            stacked: true,
                            ticks: {
                                autoSkip: false,
                                maxRotation: 90,
                                minRotation: 90
                            }
                        },
                        y: {
                            stacked: true,
                        }
                    },
                    plugins: {
                        legend: {
                            position: "top",
                            align: "start",
                            labels: {
                                boxWidth: 10,
                                textAlign: "left",
                            }
                        }
                    }
                }
            }
            myChartSP = new Chart(ctxSP, options); 
            myChartPC = new Chart(ctxPC, options); 
        });
    });
    

// 各病院のDPCcodeグラフ
    hospitals.forEach(hospital=>{
        const canvasSP = document.getElementById(`DPCcodeChartSP${hospital._id}`);
        const canvasPC = document.getElementById(`DPCcodeChartPC${hospital._id}`);
        if (!canvasSP || !canvasPC) return;

        const ctxSP = canvasSP.getContext("2d");
        const ctxPC = canvasPC.getContext("2d");
        const data = [];

        if(check0orNot(hospital,disease1)){
            const d = {
                label: "大血管転位症手術 大血管血流転換術(ジャテーン手術)等",
                data: calcNumber(hospital,disease1),
            }
            data.push(d);
        }

        if(check0orNot(hospital,disease2)){
            const d = {
                label: "ファロー四徴症手術等",
                data: calcNumber(hospital,disease2),
            };
            data.push(d);
        }
            
        if(check0orNot(hospital,disease3)){
            const d =  {
                label: "弁形成術",
                data: calcNumber(hospital,disease3),
            };
            data.push(d);
        }

        if(check0orNot(hospital,disease4)){
            const d = {
                label: "心室中隔欠損閉鎖術",
                data: calcNumber(hospital,disease4),
            };
            data.push(d);
        }
        
        if(check0orNot(hospital,disease5)){
            const d = {
                label: "その他の手術",
                data: calcNumber(hospital,disease5),
            };
            data.push(d)
        }

        const options = {
            type: "bar",
            data: {
                labels: yearsData,
                datasets: data
            },
            options: {
                responsive: true,
                scales: {
                    x: {
                        stacked: true,
                    },
                    y: {
                        stacked: true,
                    }
                },
                plugins: {
                    legend: {
                        position: "top",
                        align: "start",
                        labels: {
                            boxWidth: 10,
                            textAlign: "left",
                        }
                    }
                }
            }
        };
        new Chart(ctxSP, options);
        new Chart(ctxPC, options);
    });
    console.log("hospitalData.ejs loaded");

// 各病院のKcodeグラフ
    hospitals.forEach(hospital=>{
        const ctxSP = document.getElementById(`KcodeChartSP${hospital._id}`).getContext("2d");
        const ctxPC = document.getElementById(`KcodeChartPC${hospital._id}`).getContext("2d");
        const data = [];
        for(let Kcode in KcodeName){
            if(
                hospital.R3Kcode&&hospital.R3Kcode[Kcode]&&hospital.R3Kcode[Kcode][0]!==0||
                hospital.R4Kcode&&hospital.R4Kcode[Kcode]&&hospital.R4Kcode[Kcode][0]!==0||
                hospital.R5Kcode&&hospital.R5Kcode[Kcode]&&hospital.R5Kcode[Kcode][0]!==0||
                hospital.R6Kcode&&hospital.R6Kcode[Kcode]&&hospital.R6Kcode[Kcode][0]!==0
            ) {
                const d = {
                    label: KcodeName[Kcode],
                    data: [
                        hospital.R3Kcode&&hospital.R3Kcode[Kcode]?
                        hospital.R3Kcode[Kcode][0]:0,
                        hospital.R4Kcode&&hospital.R4Kcode[Kcode]?
                        hospital.R4Kcode[Kcode][0]:0,
                        hospital.R5Kcode&&hospital.R5Kcode[Kcode]?
                        hospital.R5Kcode[Kcode][0]:0,
                        hospital.R6Kcode&&hospital.R6Kcode[Kcode]?
                        hospital.R6Kcode[Kcode][0]:0
                    ],
                };
                data.push(d);
            }
        }
        const options = {
            type: "bar",
            data: {
                labels: yearsData,
                datasets: data
            },
            options: {
                responsive: true,
                scales: {
                    x: {
                        stacked: true,
                    },
                    y: {
                        stacked: true,
                    }
                },
                plugins: {
                    legend: {
                        position: "top",
                        align: "start",
                        labels: {
                            boxWidth: 10,
                            textAlign: "left",
                        }
                    }
                }
            }
        };
        if (ctxSP && data.length > 0) new Chart(ctxSP, options);
if (ctxPC && data.length > 0) new Chart(ctxPC, options);
    })

</script>
